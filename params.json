{"name":"Active Analytics Ltd Blog","tagline":"Plotting live charts with Yahoo Finance data and ggplot2 in R ","body":"# Plotting live charts with Yahoo Finance data and ggplot2 in R \r\n\r\n## Google stock price with 'live' data from Yahoo Finance\r\nby [Active Analytics](http://www.activeanalytics.co.uk/)\r\n<img src=\"https://raw.github.com/ActiveAnalytics/AABlog/master/2013-05-17_RYahooCharting/plot2.jpg\" alt=\"Drawing\" style=\"width: 800px;\"/>\r\n\r\n[Link to the picture](https://raw.github.com/ActiveAnalytics/AABlog/master/2013-05-17_RYahooCharting/plot2.jpg)\r\n\r\n## News\r\n\r\nThere are a few announcements that need to be made before I launch into this week's blog.\r\n\r\n### Active Analytics Ltd : New R Course: R for Reserving Actuaries\r\n\r\nThis course is a two-day course for people that have already been on the three day [Introduction to R course](http://www.activeanalytics.co.uk/r-training). The program is as follows\r\n\r\n1. Data structures for reserving data in R\r\n2. Plotting for reserving data\r\n3. Writing your own reserving methods and working with data in R\r\n4. Chain Ladder\r\n5. Cape Cod\r\n6. Curve Fitting methods\r\n7. Generalized linear models\r\n8. Introduction to the [ChainLadder](http://cran.r-project.org/web/packages/ChainLadder/) package\r\n9. Introduction to space state methods for reserving in R\r\n10. Simulation methods for reserving in R\r\n\r\n### The R In Insurance Conference\r\n\r\nI would like to mention the [R in Insurance Conference](http://lamages.blogspot.co.uk/2013/05/r-in-insurance-programme-and-abstracts.html). There will be very interesting talks, from all major fields of actuarial practice: reserving, pricing, capital modelling, catastrophe modelling and many other interesting R-related tools and techniques that are relevant this field. R is a very important statistical, data mining,  data manipulation and analysis tool in many sectors and is beginning to make inroads in the insurance market. Its adoption is really a no-brainer when you consider its tool-set and versatility.\r\n\r\n## Introduction\r\n\r\nI have been pretty busy with work and travelling this week and the nature of this blog entry required an internet connection to ensure that the code works properly, so it has taken a little longer to get it together. \r\n\r\nThe principle aim is simple, you would like to pull some stock price data from Yahoo Finance, live (in this case it is delayed) and plot this in R. Of course you can choose to analyse the data live as well as plotting, but today we will keep it simple and focus on pulling the data from the [Yahoo Finance  CSV API](https://code.google.com/p/yahoo-finance-managed/wiki/YahooFinanceAPIs) and plotting in [ggplot2](http://cran.r-project.org/web/packages/ggplot2/index.html). \r\n\r\nYou could also choose to plot using Google charts, and if you are working with R, there is a great package [googleVis](https://code.google.com/p/google-motion-charts-with-r/) by Markus Gesmann. His googleVis blog is located [here](http://lamages.blogspot.co.uk/search/label/googleVis). Incidentally, he is one of the organizers of the R In Insurance Conference.\r\n\r\nWe require just two packages here, ggplot2, and [gridExtra](http://cran.r-project.org/web/packages/gridExtra/index.html) which as well as providing more functionality to the grid package allows us to arrange ggplot2 charts together.\r\n\r\n```\r\noptions(stringsAsFactors = F)\r\nrequire(ggplot2)\r\nrequire(gridExtra)\r\n```\r\n\r\n## Downloading stock quote data from the Yahoo Finance API\r\n\r\nI use the 'live' to describe the live data because, it is made clear that the stock data is delayed. We will be concerned with loading data using the CSV api, which really only involves creating the the appropriate URL. A simple tutorial on creating this URL is given [here](https://code.google.com/p/yahoo-finance-managed/wiki/csvQuotesDownload) and the property list of the items is given [here](https://code.google.com/p/yahoo-finance-managed/wiki/enumQuoteProperty).\r\n\r\nThe first thing I do is to create an environment to store the data, this is not essential but often with processes like this it may be safer not to have the source data frame hanging around the global environment so that it is not unexpectedly changed and so we are forced to `get()` and `assign()` values to it.\r\n\r\n```\r\n# Creating the environment\r\nassign(\"envPrevData\", new.env(), envir = .GlobalEnv)\r\n```\r\n\r\nWe then use the `paste()` function to generate our URL query and download it using the `read.table()` function. The time given for the stock quote is to the nearest minute but we can download more frequently than this. I have chosen to use the system time `Sys.time()` on the machine which is will be the time just after I made the query. In addition, the time I am using is local here, `BST` but obviously \"GOOG\" is traded on NASDAQ which has `EDT`.\r\n\r\nEach call to this function will obtain a row of data ready to be appended to the main data frame.\r\n\r\n```\r\n# Function to get the data\r\nGetLiveData <- function(sSymbol = \"GOOG\")\r\n{\r\n\tsAddress <- paste(\"http://download.finance.yahoo.com/d/quotes.csv?s=\", \r\n\t\tsSymbol, \"&f=nsb2b3v0&e=.csv\", sep = \"\")\r\n\tcat(\"Downloading data from \", sAddress, \"\\n\")\r\n\tdfYahooData <- read.table(sAddress, sep = \",\", header = F)\r\n\t# I chose to create my own time \r\n\tTime <- Sys.time()\r\n\t# Appending the time to the data frame\r\n\tdfYahooData <- cbind(dfYahooData, \"Time\" = Time)\r\n\t# Adding the column names\r\n\tnames(dfYahooData) <- c(\"Name\", \"Symbol\", \"Ask\", \"Bid\", \"Volume\", \"Time\")\r\n\tdfYahooData\r\n}\r\n```\r\n\r\n## The stock update function\r\n\r\nOnce we have downloaded the data we need a function to ensure that it is appended to the main data frame. The other nice thing about working with environments is that any name you want is already a `NULL` and you can append to it. For instance, if dfStockData does not exist in the global environment, you cannot append data to it for example, this\r\n\r\n```\r\n# Here dfCurr exists but dfStockData does not\r\nrbind.data.frame(dfStockData, dfCurr)\r\n```\r\n\r\nWould give an error since dfStockData does not exist but if we create an environment \"envPrevData\", we can just do this\r\n\r\n```\r\n# Here dfCurr exists but dfStockData does not\r\nrbind.data.frame(envPrevData$dfStockData, dfCurr)\r\n```\r\n\r\nand carry on spontaneously appending or assigning things as we like. I take advantage of this to append the data to a data frame the environment without worrying about initializing it first\r\n\r\n```\r\n# Function to update the current data\r\nUpdateStockData <- function(sSymbol = \"GOOG\")\r\n{\r\n\tenvPrevData <- get(\"envPrevData\", envir = .GlobalEnv, mode = \"environment\")\r\n\tdfCurr <- GetLiveData(sSymbol = sSymbol)\r\n\tprint(dfCurr)\r\n\ttry(envPrevData$dfStockData <- rbind.data.frame(envPrevData$dfStockData, dfCurr))\r\n\tassign(\"envPrevData\", envPrevData, envir = .GlobalEnv)\r\n\t\r\n\tinvisible()\r\n}\r\n```\r\n\r\n## The plotting function\r\n\r\nThe plotting function is a bit of a beast, it has to be admitted. Just consider that there are three parts.\r\n\r\n1. Some small data preparation to get the bid and ask movements. The midpoint is also calculated though it and the bid movements are not used.\r\n2. The first plot creates the bid-ask line range chart on the top.\r\n3. The second plot creates the volume bar chart below bid ask chart\r\n\r\n```\r\n# The plot function\r\nplotChart <- function(){\r\n\t# Here we get the data\r\n\tenvPrevData <- get(\"envPrevData\", envir = .GlobalEnv, mode = \"environment\")\r\n\tdfStockData <- envPrevData$dfStockData\r\n\t# We only want to plot if we have five or more points\r\n\tif(nrow(dfStockData) > 4){\r\n\t\t# 1. We prepare the data\r\n\t\tAskMovement <- factor(sign(c(0, diff(dfStockData$Ask))), levels = c(-1, 0, 1), \r\n\t\t\tlabels = c(\"Down\", \"No Change\", \"Up\"))\r\n\t\tBidMovement <- factor(sign(c(0, diff(dfStockData$Bid))), levels = c(-1, 0, 1), \r\n\t\t\tlabels = c(\"Down\", \"No Change\", \"Up\"))\r\n\t\tVolumeChange <- c(0, diff(dfStockData$Volume))\r\n\t\tdfStockData <- data.frame(dfStockData, AskMovement, BidMovement, VolumeChange)\r\n\t\t\r\n\t\tdfStockData$Mid <- with(dfStockData, .5*(Bid + Ask))\r\n\t\t\r\n\t\t# 2. This is the first plot for the Bid-Ask\r\n\t\tbAPlot <- ggplot(dfStockData, aes(Time, Mid,\r\n\t\t  ymin = Bid, ymax= Ask, colour = AskMovement))\r\n\t\tbAPlot <- bAPlot + geom_linerange(lwd = 1.5) + xlab(\"\") + ylab(\"Price\\n\")\r\n\t\tbAPlot <- bAPlot +  theme(legend.position = \"top\", \r\n\t\t\tplot.margin = unit(c(0, .5, -1.5, 0), \"lines\"), \r\n\t\t\taxis.text.y = element_text(angle = 90), axis.text.x = element_blank()) + \r\n\t\t\tlabs(colour = \"Ask Movement\") + \r\n\t\t\txlim(range(dfStockData$Time)) + \r\n\t\t\tscale_colour_manual(values=c(\"red\", \"blue\", \"green\"))\r\n\r\n\t\t# 3. This is the Volume change plot\r\n\t\tVolPlot <- qplot(y = VolumeChange, x = Time, data=dfStockData, \r\n\t\t\tgeom=\"bar\", stat = \"identity\", fill = AskMovement)\r\n\t\tVolPlot <- VolPlot + theme(legend.position = \"none\", \r\n\t\t\tplot.margin = unit(c(0, .5, 0, 0), \"lines\"), \r\n\t\t\taxis.text.y = element_text(angle = 90)) + \r\n\t\t\txlab(\"\\nTime\") + ylab(\"Volume Change\\n\") +\r\n\t\t\txlim(range(dfStockData$Time)) + \r\n\t\t\tscale_colour_manual(values=c(\"red\", \"blue\", \"green\"))\r\n\t\t\r\n\t\t# We use grid arrange to arrange the plots\r\n\t\tgrid.arrange(bAPlot, VolPlot, nrow = 2, heights = c(1.5, 1))\r\n\t}\r\n}\r\n```\r\n\r\n## Executing the process\r\n\r\nWe Finally bring everything together and run the code\r\n\r\n```\r\n# Running the process\r\nCurrTime <- Sys.time()\r\nwhile(Sys.time() < CurrTime + 60*60){\r\n\tUpdateStockData(\"GOOG\")\r\n\tplotChart()\r\n\tSys.sleep(30)\r\n}\r\n```\r\n\r\n## Conclusion\r\n\r\nThis is clearly a quick and dirty example, but shows how you can start constructing your own analysis tool based on 'live' quotes from Yahoo. The Yahoo Finance CSV api is very easy to use but there are some unfortunate problems. The bid and ask volumes can come down with commas for separating thousands zeros which is a great shame for a CSV formatted object. I have no idea why commas should be in numbers in the first place - unless you take them as decimal points in which case a very different separator should be used.\r\n\r\nTo get interactive graphics, the Google charts api is good and the googleVis package is convenient for R programmers.\r\n\r\nThe complete code for this blog is located [here](https://github.com/ActiveAnalytics/AABlog/blob/master/2013-05-17_RYahooCharting/2013-05-17_RYahooCharting.R)\r\n\r\n[Chibisi Chima-Okereke](http://www.activeanalytics.co.uk/)","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}